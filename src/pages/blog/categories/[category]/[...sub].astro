---
import Layout from "../../../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import SkillBadge from "../../../../components/SkillBadge.astro";
import { House, FolderOpen, ChevronRight } from "@lucide/astro";

export async function getStaticPaths() {
  const posts = await getCollection("blog");

  // 从文章派生出所有已有的层级路径
  const pairs = new Set<string>();
  for (const p of posts) {
    const segs = p.id.split("/"); // [category, sub1, sub2, ..., post]
    if (segs.length >= 3) {
      // 生成 category/sub1、category/sub1/sub2 等中间层级
      for (let depth = 2; depth < segs.length; depth++) {
        const category = segs[0];
        const sub = segs.slice(1, depth).join("/");
        pairs.add(`${category}::${sub}`);
      }
    }
  }

  // 预置的一级子主题，保证无文章时也能生成路径
  const seedSubtopicsByCategory: Record<string, string[]> = {
    llms: ["training", "inference", "quantization"],
    "competitive-programming": ["data-structure", "dp", "atcoder", "codeforces", "leetcode"],
    essay: [],
  };
  Object.entries(seedSubtopicsByCategory).forEach(([category, subs]) => {
    subs.forEach((sub) => pairs.add(`${category}::${sub}`));
  });

  return Array.from(pairs).map((pair) => {
    const [category, sub] = pair.split("::");
    return { params: { category, sub } };
  });
}

const { category, sub } = Astro.params;
const subSegments = (sub || "").split("/").filter(Boolean);
const prefix = [category, ...subSegments].join("/");

const posts = await getCollection("blog");

// 当前层级下的文章（含更深层）
const filtered = posts
  .filter((p) => p.id.startsWith(`${prefix}/`) || p.id === prefix)
  .sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime());

// 下一层子主题（立即下一级目录）
const prefixSegCount = 1 + subSegments.length;
const nextTopics = Array.from(
  new Set(
    filtered
      .map((p) => {
        const segs = p.id.split("/");
        return segs.length > prefixSegCount + 1 ? segs[prefixSegCount] : null;
      })
      .filter(Boolean)
  )
).sort();

// 新增：统计下一层主题的文章数量
const nextTopicCounts = Object.fromEntries(
  nextTopics.map((topic) => [
    topic,
    filtered.filter(
      (p) =>
        p.id === `${prefix}/${topic}` ||
        p.id.startsWith(`${prefix}/${topic}/`)
    ).length,
  ])
);

function formatDate(date: Date) {
  return date.toLocaleDateString("en-US", { month: "long", day: "numeric", year: "numeric" });
}
---
<Layout title={`Blog - ${category}/${sub}`} description={`Browse ${category}/${sub} topics and posts`}>
  <main class="max-w-6xl mx-auto px-4 py-20">
    <!-- Breadcrumbs -->
    <div class="mb-6 text-sm breadcrumbs">
      <ul class="items-center">
        <li class="flex items-center gap-1">
          <House class="size-4" />
          <a href="/blog">Blog</a>
        </li>
        <li class="flex items-center gap-1">
          <FolderOpen class="size-4" />
          <a href={`/blog/categories/${category}`}>{category}</a>
        </li>
        {
          subSegments.map((seg, i) => {
            const link = `/blog/categories/${category}/${subSegments.slice(0, i + 1).join("/")}`;
            return (
              <li class="flex items-center gap-1">
                <ChevronRight class="size-4" />
                <a href={link}>{seg}</a>
              </li>
            );
          })
        }
      </ul>
    </div>

    <!-- Next-level topics -->
    {
      nextTopics.length > 0 && (
        <section class="mb-10">
          <h2 class="text-2xl font-semibold mb-4 flex items-center gap-2">
            <FolderOpen class="size-5" />
            Topics
          </h2>
          <div class="flex flex-wrap gap-3">
            {
              nextTopics.map((topic) => (
                <a
                  href={`/blog/categories/${category}/${[...subSegments, topic].join("/")}`}
                  class="btn btn-sm btn-outline rounded-full gap-1 hover:border-primary hover:text-primary"
                >
                  <ChevronRight class="size-4" />
                  <span class="capitalize">{topic.replace(/-/g, " ")}</span>
                  <span class="badge badge-sm ml-1">{nextTopicCounts[topic] ?? 0}</span>
                </a>
              ))
            }
          </div>
        </section>
      )
    }

    <!-- Posts in this level -->
    <section>
      <h2 class="text-2xl font-semibold mb-4">Posts</h2>
      {
        filtered.length === 0 ? (
          <p class="text-base-content/60">No posts here yet.</p>
        ) : (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {
              filtered.map((post) => (
                <article class="card bg-base-100/70 backdrop-blur border border-base-200 rounded-2xl hover:border-primary/40 hover:shadow-2xl transition-all">
                  <figure class="aspect-video">
                    <Image
                      src={post.data.image}
                      alt={post.data.title}
                      class="w-full h-full object-cover"
                      width={600}
                      height={400}
                    />
                  </figure>
                  <div class="card-body">
                    <time class="text-sm text-base-content/60">
                      {formatDate(post.data.publishDate)}
                    </time>
                    <h2 class="card-title hover:text-primary transition-colors">
                      <a href={`/blog/${post.id}`}>{post.data.title}</a>
                    </h2>
                    <p class="text-base-content/80">{post.data.description}</p>
                    {post.data.tags && post.data.tags.length > 0 && (
                      <div class="flex flex-wrap gap-2 mt-2">
                        {post.data.tags.map((t) => (<SkillBadge skill={t} />))}
                      </div>
                    )}
                    <div class="card-actions justify-end mt-4">
                      <a href={`/blog/${post.id}`} class="btn btn-primary btn-sm">Read More</a>
                    </div>
                  </div>
                </article>
              ))
            }
          </div>
        )
      }
    </section>
  </main>
</Layout>