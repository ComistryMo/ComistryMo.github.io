---
import Layout from "../../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { Image } from "astro:assets";
import SkillBadge from "../../../components/SkillBadge.astro";
import { FolderOpen, ChevronRight } from "@lucide/astro";

export async function getStaticPaths() {
  const baseCategories = ["essay", "llms", "competitive-programming"];

  const posts = await getCollection("blog");
  const fromPosts = new Set<string>();
  for (const p of posts) {
    const segs = p.id.split("/");
    if (segs.length >= 1 && segs[0]) fromPosts.add(segs[0]);
  }

  const categories = Array.from(new Set([...baseCategories, ...fromPosts]));
  return categories.map((category) => ({ params: { category } }));
}

const { category } = Astro.params;
const posts = await getCollection("blog");

// 当前分类下的所有文章
const categoryPosts = posts
  .filter((p) => p.id.startsWith(`${category}/`))
  .sort((a, b) => b.data.publishDate.getTime() - a.data.publishDate.getTime());

// 预置子主题（即使暂时没有文章也能显示入口）
const seedSubtopicsByCategory: Record<string, string[]> = {
  llms: ["training", "inference", "quantization"],
  "competitive-programming": ["data-structure", "dp", "atcoder", "codeforces", "leetcode"],
  essay: [],
};

// 文章派生的子主题（第二层目录）
const derived = Array.from(
  new Set(
    categoryPosts
      .map((p) => p.id.split("/")[1])
      .filter(Boolean)
  )
);

// 合并预置与派生
const subtopics = Array.from(
  new Set([...(seedSubtopicsByCategory[category] ?? []), ...derived])
).sort();

function formatDate(date: Date) {
  return date.toLocaleDateString("en-US", { month: "long", day: "numeric", year: "numeric" });
}

// 新增：统计每个子主题的文章数量（按目录前缀聚合）
const topicCounts = Object.fromEntries(
  subtopics.map((topic) => [
    topic,
    categoryPosts.filter(
      (p) =>
        p.id === `${category}/${topic}` ||
        p.id.startsWith(`${category}/${topic}/`)
    ).length,
  ])
);
---

<Layout title={`Blog - ${category}`} description={`Browse ${category} topics and posts`}>
  <main class="max-w-6xl mx-auto px-4 py-20">
    <!-- Header -->
    <div class="text-center mb-10">
      <h1 class="text-5xl font-bold mb-2 text-primary">{category}</h1>
      <p class="text-base-content/70">Choose a topic or read latest posts.</p>
    </div>

    <!-- Subtopics -->
    {
      subtopics.length > 0 && (
        <section class="mb-10">
          <h2 class="text-2xl font-semibold mb-4 flex items-center gap-2">
            <FolderOpen class="size-5" />
            Topics
          </h2>
          <div class="flex flex-wrap gap-3">
            {
              subtopics.map((topic) => (
                <a
                  href={`/blog/categories/${category}/${topic}`}
                  class="btn btn-sm btn-outline rounded-full gap-1 hover:border-primary hover:text-primary"
                >
                  <ChevronRight class="size-4" />
                  <span class="capitalize">{topic.replace(/-/g, " ")}</span>
                  <span class="badge badge-sm ml-1">{topicCounts[topic] ?? 0}</span>
                </a>
              ))
            }
          </div>
        </section>
      )
    }

    <!-- Latest posts in this category -->
    <section>
      <h2 class="text-2xl font-semibold mb-4">Latest in {category}</h2>
      {
        categoryPosts.length === 0 ? (
          <p class="text-base-content/60">No posts yet.</p>
        ) : (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {
              categoryPosts.slice(0, 9).map((post) => (
                <article class="card bg-base-100/70 backdrop-blur border border-base-200 rounded-2xl hover:border-primary/40 hover:shadow-2xl transition-all">
                  <figure class="aspect-video">
                    <Image
                      src={post.data.image}
                      alt={post.data.title}
                      class="w-full h-full object-cover"
                      width={600}
                      height={400}
                    />
                  </figure>
                  <div class="card-body">
                    <time class="text-sm text-base-content/60">
                      {formatDate(post.data.publishDate)}
                    </time>
                    <h2 class="card-title hover:text-primary transition-colors">
                      <a href={`/blog/${post.id}`}>{post.data.title}</a>
                    </h2>
                    <p class="text-base-content/80">{post.data.description}</p>
                    {post.data.tags && post.data.tags.length > 0 && (
                      <div class="flex flex-wrap gap-2 mt-2">
                        {post.data.tags.map((t) => (<SkillBadge skill={t} />))}
                      </div>
                    )}
                    <div class="card-actions justify-end mt-4">
                      <a href={`/blog/${post.id}`} class="btn btn-primary btn-sm">Read More</a>
                    </div>
                  </div>
                </article>
              ))
            }
          </div>
        )
      }
    </section>
  </main>
</Layout>